var testStatus=-1,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",dlProgress=0,ulProgress=0,pingProgress=0,dlAmount=0,ulAmount=0,log="";function tlog(a){log+=Date.now()+": "+a+"\n"}function twarn(a){log+=Date.now()+" WARN: "+a+"\n",console.warn(a)}var settings={test_order:"IP_D_U",time_ul:15,time_dl:15,time_ulGraceTime:3,time_dlGraceTime:1.5,count_ping:35,url_dl:"garbage.php",url_ul:"empty.php",url_ping:"empty.php",url_getIp:"getIP.php",getIp_ispInfo:!0,getIp_ispInfo_distance:"km",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_multistreamDelay:300,xhr_ignoreErrors:1,xhr_dlUseBlob:!1,garbagePhp_chunkSize:20,emptyPhp_chunkSize:20,enable_quirks:!0,ping_allowPerformanceApi:!0,overheadCompensationFactor:1.06,useMebibits:!1,telemetry_level:0,url_telemetry:"telemetry.php"},xhr=null,interval=null,test_pointer=0;function url_sep(a){return a.match(/\?/)?"&":"?"}function sendStatus(){postMessage(testStatus+";"+dlStatus+";"+ulStatus+";"+pingStatus+";"+clientIp+";"+jitterStatus+";"+dlProgress+";"+ulProgress+";"+pingProgress+";"+dlAmount+";"+ulAmount)}this.addEventListener("message",function(a){var b=a.data.split(" ");if("status"===b[0]&&sendStatus(),"start"===b[0]&&-1==testStatus){testStatus=0;try{var c={};try{var d=a.data.substring(5);d&&(c=JSON.parse(d))}catch(a){twarn("Error parsing custom settings JSON. Please check your syntax")}for(var e in c)"undefined"==typeof settings[e]?twarn("Unknown setting ignored: "+e):settings[e]=c[e];if(settings.enable_quirks||"undefined"!=typeof c.enable_quirks&&c.enable_quirks){var f=navigator.userAgent;/LMY49J/i.test(f)&&"undefined"==typeof c.emptyPhp_chunkSize&&(settings.emptyPhp_chunkSize=10),/Firefox.(\d+\.\d+)/i.test(f)&&"undefined"==typeof c.xhr_ulMultistream&&(settings.xhr_ulMultistream=1),/Edge.(\d+\.\d+)/i.test(f)&&"undefined"==typeof c.xhr_dlMultistream&&(settings.xhr_dlMultistream=3),/Chrome.(\d+)/i.test(f)&&!!self.fetch&&"undefined"==typeof c.xhr_dlMultistream&&(settings.xhr_dlMultistream=5)}/Edge.(\d+\.\d+)/i.test(f)&&(settings.forceIE11Workaround=!0),"undefined"!=typeof c.telemetry_level&&(settings.telemetry_level="basic"===c.telemetry_level?1:"full"===c.telemetry_level?2:0),settings.test_order=settings.test_order.toUpperCase()}catch(a){twarn("Possible error in custom test settings. Some settings may not be applied. Exception: "+a)}tlog(JSON.stringify(settings)),test_pointer=0;var g=!1,h=!1,i=!1,j=!1,k=function(){if(5!=testStatus){if(test_pointer>=settings.test_order.length)return testStatus=4,sendStatus(),void sendTelemetry();switch(settings.test_order.charAt(test_pointer)){case"I":{if(test_pointer++,g)return void k();g=!0,getIp(k)}break;case"D":{if(test_pointer++,h)return void k();h=!0,testStatus=1,dlTest(k)}break;case"U":{if(test_pointer++,i)return void k();i=!0,testStatus=3,ulTest(k)}break;case"P":{if(test_pointer++,j)return void k();j=!0,testStatus=2,pingTest(k)}break;case"_":test_pointer++,setTimeout(k,1e3);break;default:test_pointer++;}}};k()}"abort"===b[0]&&(tlog("manually aborted"),clearRequests(),k=null,interval&&clearInterval(interval),1<settings.telemetry_level&&sendTelemetry(),testStatus=5,dlStatus="",ulStatus="",pingStatus="",jitterStatus="")});function clearRequests(){if(tlog("stopping pending XHRs"),xhr){for(var a=0;a<xhr.length;a++){try{xhr[a].onprogress=null,xhr[a].onload=null,xhr[a].onerror=null}catch(a){}try{xhr[a].upload.onprogress=null,xhr[a].upload.onload=null,xhr[a].upload.onerror=null}catch(a){}try{xhr[a].abort()}catch(a){}try{delete xhr[a]}catch(a){}}xhr=null}}var ipCalled=!1;function getIp(a){(tlog("getIp"),!ipCalled)&&(ipCalled=!0,xhr=new XMLHttpRequest,xhr.onload=function(){tlog("IP: "+xhr.responseText),clientIp=xhr.responseText,a()},xhr.onerror=function(){tlog("getIp failed"),a()},xhr.open("GET",settings.url_getIp+url_sep(settings.url_getIp)+(settings.getIp_ispInfo?"isp=true"+(settings.getIp_ispInfo_distance?"&distance="+settings.getIp_ispInfo_distance+"&":"&"):"&")+"r="+Math.random(),!0),xhr.send())}var dlCalled=!1;function dlTest(a){if(tlog("dlTest"),!dlCalled){dlCalled=!0;var b=0,c=new Date().getTime(),d=!1,e=!1;xhr=[];for(var f=function(a,c){setTimeout(function(){if(1==testStatus){tlog("dl test stream started "+a+" "+c);var d=0,g=new XMLHttpRequest;xhr[a]=g,xhr[a].onprogress=function(c){if(tlog("dl stream progress event "+a+" "+c.loaded),1!=testStatus)try{g.abort()}catch(a){}var e=0>=c.loaded?0:c.loaded-d;isNaN(e)||!isFinite(e)||0>e||(b+=e,d=c.loaded)}.bind(this),xhr[a].onload=function(){tlog("dl stream finished "+a);try{xhr[a].abort()}catch(a){}f(a,0)}.bind(this),xhr[a].onerror=function(){tlog("dl stream failed "+a),0===settings.xhr_ignoreErrors&&(e=!0);try{xhr[a].abort()}catch(a){}delete xhr[a],1===settings.xhr_ignoreErrors&&f(a,0)}.bind(this);try{xhr[a].responseType=settings.xhr_dlUseBlob?"blob":"arraybuffer"}catch(a){}xhr[a].open("GET",settings.url_dl+url_sep(settings.url_dl)+"r="+Math.random()+"&ckSize="+settings.garbagePhp_chunkSize,!0),xhr[a].send()}}.bind(this),1+c)}.bind(this),g=0;g<settings.xhr_dlMultistream;g++)f(g,settings.xhr_multistreamDelay*g);interval=setInterval(function(){tlog("DL: "+dlStatus+(d?"":" (in grace time)"));var f=new Date().getTime()-c;if(d&&(dlProgress=f/(1e3*settings.time_dl)),!(200>f))if(!d)f>1e3*settings.time_dlGraceTime&&(0<b&&(c=new Date().getTime(),b=0),d=!0);else{dlAmount=b;var g=b/(f/1e3);dlStatus=(8*g*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),sendStatus(),(f/1e3>settings.time_dl&&0<dlStatus||e)&&((e||isNaN(dlStatus))&&(dlStatus="Fail"),clearRequests(),clearInterval(interval),dlProgress=1,tlog("dlTest finished "+dlStatus),a())}}.bind(this),200)}}var ulCalled=!1;function ulTest(a){if(tlog("ulTest"),!ulCalled){ulCalled=!0;var b=new ArrayBuffer(1048576);try{b=new Float32Array(b);for(var c=0;c<b.length;c++)b[c]=Math.random()}catch(a){}for(var d=[],e=[],c=0;c<settings.emptyPhp_chunkSize;c++)d.push(b);d=new Blob(d),b=new ArrayBuffer(262144);try{b=new Float32Array(b);for(var c=0;c<b.length;c++)b[c]=Math.random()}catch(a){}e.push(b),e=new Blob(e);var f=0,g=new Date().getTime(),h=!1,j=!1;xhr=[];for(var k=function(a,b){setTimeout(function(){if(3==testStatus){tlog("ul test stream started "+a+" "+b);var c=0,g=new XMLHttpRequest;xhr[a]=g;var h;if(settings.forceIE11Workaround)h=!0;else try{xhr[a].upload.onprogress,h=!1}catch(a){h=!0}h?(xhr[a].onload=function(){tlog("ul stream progress event (ie11wa)"),f+=e.size,k(a,0)},xhr[a].onerror=function(){tlog("ul stream failed (ie11wa)"),0===settings.xhr_ignoreErrors&&(j=!0);try{xhr[a].abort()}catch(a){}delete xhr[a],1===settings.xhr_ignoreErrors&&k(a,0)},xhr[a].open("POST",settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),!0),xhr[a].setRequestHeader("Content-Encoding","identity"),xhr[a].send(e)):(xhr[a].upload.onprogress=function(b){if(tlog("ul stream progress event "+a+" "+b.loaded),3!=testStatus)try{g.abort()}catch(a){}var d=0>=b.loaded?0:b.loaded-c;isNaN(d)||!isFinite(d)||0>d||(f+=d,c=b.loaded)}.bind(this),xhr[a].upload.onload=function(){tlog("ul stream finished "+a),k(a,0)}.bind(this),xhr[a].upload.onerror=function(){tlog("ul stream failed "+a),0===settings.xhr_ignoreErrors&&(j=!0);try{xhr[a].abort()}catch(a){}delete xhr[a],1===settings.xhr_ignoreErrors&&k(a,0)}.bind(this),xhr[a].open("POST",settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),!0),xhr[a].setRequestHeader("Content-Encoding","identity"),xhr[a].send(d))}}.bind(this),1)}.bind(this),c=0;c<settings.xhr_ulMultistream;c++)k(c,settings.xhr_multistreamDelay*c);interval=setInterval(function(){tlog("UL: "+ulStatus+(h?"":" (in grace time)"));var b=new Date().getTime()-g;if(h&&(ulProgress=b/(1e3*settings.time_ul)),!(200>b))if(!h)b>1e3*settings.time_ulGraceTime&&(0<f&&(g=new Date().getTime(),f=0),h=!0);else{ulAmount=f;var c=f/(b/1e3);ulStatus=(8*c*settings.overheadCompensationFactor/(settings.useMebibits?1048576:1e6)).toFixed(2),sendStatus(),(b/1e3>settings.time_ul&&0<ulStatus||j)&&((j||isNaN(ulStatus))&&(ulStatus="Fail"),clearRequests(),clearInterval(interval),ulProgress=1,tlog("ulTest finished "+ulStatus),a())}}.bind(this),200)}}var ptCalled=!1;function pingTest(a){if(tlog("pingTest"),!ptCalled){ptCalled=!0;var b=null,c=0,e=0,f=0,g=0,h=0;xhr=[];var j=function(){tlog("ping"),pingProgress=h/settings.count_ping,b=new Date().getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(tlog("pong"),0===h)b=new Date().getTime();else{var i=new Date().getTime()-b;if(settings.ping_allowPerformanceApi)try{var k=performance.getEntries();k=k[k.length-1];var l=k.responseStart-k.requestStart;0>=l&&(l=k.duration),0<l&&l<i&&(i=l)}catch(a){tlog("Performance API not supported, using estimate")}f+=i,g+=i*i,c=i,e=Math.sqrt(g/h-Math.pow(f/h,2))}pingStatus=c.toFixed(2),jitterStatus=e.toFixed(2),h++,tlog("PING: "+pingStatus+" JITTER: "+jitterStatus),sendStatus(),h<settings.count_ping?setTimeout(j,100):(pingProgress=1,a())}.bind(this),xhr[0].onerror=function(){tlog("ping failed"),0===settings.xhr_ignoreErrors&&(pingStatus="Fail",jitterStatus="Fail",clearRequests(),a()),1===settings.xhr_ignoreErrors&&setTimeout(j,100),2===settings.xhr_ignoreErrors&&(h++,h<settings.count_ping?setTimeout(j,100):a())}.bind(this),xhr[0].open("GET",settings.url_ping+url_sep(settings.url_ping)+"r="+Math.random(),!0),xhr[0].send()}.bind(this);j()}}function sendTelemetry(){if(!(1>settings.telemetry_level)){xhr=new XMLHttpRequest,xhr.onload=function(){console.log("TELEMETRY OL "+xhr.responseText)},xhr.onerror=function(){console.log("TELEMETRY ERROR "+xhr)},xhr.open("POST",settings.url_telemetry+url_sep(settings.url_telemetry)+"r="+Math.random(),!0);try{var a=new FormData;a.append("dl",dlStatus),a.append("ul",ulStatus),a.append("ping",pingStatus),a.append("jitter",jitterStatus),a.append("log",1<settings.telemetry_level?log:""),xhr.send(a)}catch(a){var b="dl="+encodeURIComponent(dlStatus)+"&ul="+encodeURIComponent(ulStatus)+"&ping="+encodeURIComponent(pingStatus)+"&jitter="+encodeURIComponent(jitterStatus)+"&log="+encodeURIComponent(1<settings.telemetry_level?log:"");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(b)}}}